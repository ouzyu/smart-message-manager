FROM node:22.18.0-alpine

WORKDIR /app

# パッケージファイルをコピー
COPY package*.json ./
COPY packages/backend/package*.json ./packages/backend/
COPY packages/models-client/package*.json ./packages/models-client/
COPY packages/models/package*.json ./packages/models/
COPY packages/slack/package*.json ./packages/slack/

# workspacesを含めて依存関係をインストール
RUN npm ci --include-workspace-root --workspaces

# TypeScript設定ファイルをコピー
COPY tsconfig*.json ./
COPY nx.json ./

# ソースコードをコピー
COPY packages/models-client ./packages/models-client
COPY packages/backend ./packages/backend
COPY packages/models ./packages/models
COPY packages/slack ./packages/slack

# 開発用ポート
EXPOSE 3001

# 開発モードで起動
CMD ["npm", "run", "dev", "--prefix", "packages/backend"]